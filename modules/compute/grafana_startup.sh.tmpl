#!/usr/bin/env bash
set -euxo pipefail
export DEBIAN_FRONTEND=noninteractive

# ===== Mount external disk (bastion-data) =====
DISK_DEV="/dev/disk/by-id/google-bastion-data"   # phải trùng attached_disk.device_name="bastion-data"
MNT="/mnt/bastion-data"

if [ -e "$DISK_DEV" ]; then
  mkdir -p "$MNT"
  if ! blkid "$DISK_DEV" >/dev/null 2>&1; then
    mkfs.ext4 -F "$DISK_DEV"
  fi
  mountpoint -q "$MNT" || mount "$DISK_DEV" "$MNT"
  grep -qE "^[^#]*${DISK_DEV}[[:space:]]+${MNT}[[:space:]]" /etc/fstab || \
    echo "$DISK_DEV  $MNT  ext4  defaults,nofail  0  2" >> /etc/fstab
else
  echo "ERROR: $DISK_DEV not found. Check attached_disk.device_name = bastion-data" >&2
fi

# ===== Install & warm-up Docker =====
apt-get update -y
apt-get install -y docker.io
systemctl enable --now docker

# Chờ Docker sẵn sàng (tối đa 60s)
for i in $(seq 1 30); do
  if docker info >/dev/null 2>&1; then break; fi
  sleep 2
done
docker info >/dev/null 2>&1 || { echo "Docker not ready"; journalctl -u docker --no-pager -n 200; exit 1; }

# ===== Prepare Grafana dirs on external disk =====
# Grafana image chạy với UID/GID = 472
UID=472
GID=472

G_ROOT="$MNT/grafana"
G_PROV="$G_ROOT/provisioning"
G_DS="$G_PROV/datasources"
G_DASH="$G_ROOT/dashboards"
G_DATA="$G_ROOT/data"

mkdir -p "$G_DS" "$G_DASH" "$G_DATA"

# Quyền CHÍNH XÁC để Grafana ghi được
chown -R $UID:$GID "$G_ROOT"
find "$G_ROOT" -type d -exec chmod 755 {} \;
find "$G_ROOT" -type f -exec chmod 644 {} \;

# Datasource Stackdriver (Cloud Monitoring) dùng ADC (GCE)
cat >"$G_DS/stackdriver.yaml" <<EOF
apiVersion: 1
datasources:
  - name: Google Cloud Monitoring
    type: stackdriver
    access: proxy
    isDefault: true
    jsonData:
      authenticationType: gce
      defaultProject: ${project_id}
EOF
chown $UID:$GID "$G_DS/stackdriver.yaml"

# ===== Pull image & Run Grafana on external disk =====
docker pull grafana/grafana:latest || true
docker rm -f grafana >/dev/null 2>&1 || true

docker run -d --name grafana --restart=always \
  -p 3000:3000 \
  -e GF_SECURITY_ADMIN_USER="${grafana_admin_user}" \
  -e GF_SECURITY_ADMIN_PASSWORD="${grafana_admin_pass}" \
  -e GF_AUTH_ANONYMOUS_ENABLED=false \
  -v "$G_PROV:/etc/grafana/provisioning" \
  -v "$G_DASH:/var/lib/grafana/dashboards" \
  -v "$G_DATA:/var/lib/grafana" \
  grafana/grafana:latest

# In tình trạng để debug nhanh
sleep 2
docker ps || true
docker logs grafana --tail=100 || true
