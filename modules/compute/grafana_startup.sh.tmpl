#!/usr/bin/env bash
set -euxo pipefail

# Log để debug khi VM khởi động
exec > >(tee -a /var/log/grafana-startup.log) 2>&1

# 1) Install Docker (non-interactive)
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release software-properties-common
apt-get install -y docker.io

systemctl enable --now docker || true

# Chờ Docker daemon sẵn sàng
for i in $(seq 1 30); do
  if docker info >/dev/null 2>&1; then
    echo "docker is up"
    break
  fi
  echo "waiting for docker daemon... ($i)"
  sleep 2
done
if ! docker info >/dev/null 2>&1; then
  echo "ERROR: docker daemon did not start" >&2
  exit 1
fi

# 2) Provisioning dirs cho Grafana
install -d -m 755 /opt/grafana/provisioning/datasources
install -d -m 755 /opt/grafana/dashboards

# 3) Datasource: dùng ADC (GCE default service account)
cat >/opt/grafana/provisioning/datasources/stackdriver.yaml <<EOF
apiVersion: 1
datasources:
  - name: Google Cloud Monitoring
    type: stackdriver
    access: proxy
    isDefault: true
    jsonData:
      authenticationType: gce
      defaultProject: ${project_id}
EOF

# 4) Build docker run args (dùng ARRAY để tránh lỗi quote)
DOCKER_ARGS=(
  -d --name grafana --restart=always
  -p 3000:3000
  -e "GF_SECURITY_ADMIN_USER=${grafana_admin_user}"
  -e "GF_SECURITY_ADMIN_PASSWORD=${grafana_admin_pass}"
  -e "GF_AUTH_ANONYMOUS_ENABLED=false"
  -v /opt/grafana/provisioning:/etc/grafana/provisioning
  -v /opt/grafana/dashboards:/var/lib/grafana/dashboards
)

# 5) (Optional) SMTP – chỉ thêm nếu có giá trị
if [ -n "${grafana_smtp_host:-}" ]; then
  DOCKER_ARGS+=( -e "GF_SMTP_ENABLED=true" )
  DOCKER_ARGS+=( -e "GF_SMTP_HOST=${grafana_smtp_host}" )    # ví dụ: smtp.gmail.com:587
fi
if [ -n "${grafana_smtp_port:-}" ]; then DOCKER_ARGS+=( -e "GF_SMTP_PORT=${grafana_smtp_port}" ); fi
if [ -n "${grafana_smtp_user:-}" ]; then DOCKER_ARGS+=( -e "GF_SMTP_USER=${grafana_smtp_user}" ); fi
if [ -n "${grafana_smtp_pass:-}" ]; then DOCKER_ARGS+=( -e "GF_SMTP_PASSWORD=${grafana_smtp_pass}" ); fi
if [ -n "${grafana_smtp_from:-}" ]; then DOCKER_ARGS+=( -e "GF_SMTP_FROM_ADDRESS=${grafana_smtp_from}" ); fi
# default false nếu không set
DOCKER_ARGS+=( -e "GF_SMTP_SKIP_VERIFY=${grafana_smtp_skip_verify:-false}" )

DOCKER_IMAGE="grafana/grafana:latest"

# 6) Pull image & run
docker pull "$DOCKER_IMAGE" || true
docker rm -f grafana >/dev/null 2>&1 || true
docker run "$${DOCKER_ARGS[@]}" "$DOCKER_IMAGE"

echo "Grafana started. Access http://<bastion-public-ip>:3000"
