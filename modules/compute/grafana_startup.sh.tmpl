#!/usr/bin/env bash
set -euxo pipefail
export DEBIAN_FRONTEND=noninteractive

# ===== Mount external disk trực tiếp =====
if [ -e "/dev/disk/by-id/google-bastion-data" ]; then
  mkdir -p "/mnt/bastion-data"
  if ! blkid "/dev/disk/by-id/google-bastion-data" >/dev/null 2>&1; then
    mkfs.ext4 -F "/dev/disk/by-id/google-bastion-data"
  fi
  mountpoint -q "/mnt/bastion-data" || mount "/dev/disk/by-id/google-bastion-data" "/mnt/bastion-data"
  grep -qE "^[^#]*/dev/disk/by-id/google-bastion-data[[:space:]]+/mnt/bastion-data[[:space:]]" /etc/fstab || \
    echo "/dev/disk/by-id/google-bastion-data  /mnt/bastion-data  ext4  defaults,nofail  0  2" >> /etc/fstab
else
  echo "ERROR: /dev/disk/by-id/google-bastion-data not found. Check attached_disk.device_name=bastion-data" >&2
fi

# ===== Install & warm-up Docker =====
apt-get update -y
apt-get install -y docker.io
systemctl enable --now docker

for i in $(seq 1 30); do
  if docker info >/dev/null 2>&1; then break; fi
  sleep 2
done
docker info >/dev/null 2>&1 || { echo "Docker not ready"; exit 1; }

# ===== Prepare Grafana dirs trực tiếp trên ổ ngoài =====
mkdir -p "/mnt/bastion-data/grafana/provisioning/datasources" \
         "/mnt/bastion-data/grafana/dashboards" \
         "/mnt/bastion-data/grafana/data"

chown -R 472:472 "/mnt/bastion-data/grafana"
find "/mnt/bastion-data/grafana" -type d -exec chmod 755 {} \;
find "/mnt/bastion-data/grafana" -type f -exec chmod 644 {} \;

# ===== Tạo datasource Stackdriver =====
cat >"/mnt/bastion-data/grafana/provisioning/datasources/stackdriver.yaml" <<EOF
apiVersion: 1
datasources:
  - name: Google Cloud Monitoring
    type: stackdriver
    access: proxy
    isDefault: true
    jsonData:
      authenticationType: gce
      defaultProject: ${project_id}
EOF
chown 472:472 "/mnt/bastion-data/grafana/provisioning/datasources/stackdriver.yaml"

# ===== Run Grafana với data nằm hoàn toàn trên ổ ngoài =====
docker rm -f grafana >/dev/null 2>&1 || true
docker pull grafana/grafana:latest || true

docker run -d --name grafana --restart=always \
  -p 3000:3000 \
  -e GF_SECURITY_ADMIN_USER="${grafana_admin_user}" \
  -e GF_SECURITY_ADMIN_PASSWORD="${grafana_admin_pass}" \
  -e GF_AUTH_ANONYMOUS_ENABLED=false \
  -v "/mnt/bastion-data/grafana/provisioning:/etc/grafana/provisioning" \
  -v "/mnt/bastion-data/grafana/dashboards:/var/lib/grafana/dashboards" \
  -v "/mnt/bastion-data/grafana/data:/var/lib/grafana" \
  grafana/grafana:latest

# ===== Debug nhanh =====
sleep 3
docker ps || true
docker logs grafana --tail=50 || true
